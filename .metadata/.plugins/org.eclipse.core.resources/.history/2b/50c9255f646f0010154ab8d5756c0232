package com.courtdata.court_data_fetcher.service;

import java.time.LocalDateTime;
import java.util.Map;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.springframework.stereotype.Service;

import com.courtdata.court_data_fetcher.entity.CaseDetails;
import com.courtdata.court_data_fetcher.repository.QueryLogRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class CourtDataService {

	private final QueryLogRepository repository;

	public CaseDetails fetchCaseDetails(String caseType, String caseNumber, String filingYear) throws Exception {
		String searchUrl = "https://dhccaseinfo.nic.in/pcase/case_history.php";

		// 1️⃣ Get captcha code dynamically
		String baseUrl = "https://dhccaseinfo.nic.in/pcase/guiCaseWise.php";
		Connection.Response mainPage = Jsoup.connect(baseUrl).userAgent("Mozilla/5.0").timeout(10000).execute();

		Map<String, String> cookies = mainPage.cookies();
		Document doc = Jsoup.parse(mainPage.body());
		String captcha = doc.select("label#cap font").text();
		String randomId = doc.select("input#randomid").attr("value");

		if (captcha.isEmpty()) {
			throw new RuntimeException("Failed to get captcha");
		}

		System.out.println("Using Captcha: " + captcha);

		// 2️⃣ Submit form with case details
		Connection.Response response = Jsoup.connect(searchUrl).userAgent("Mozilla/5.0").cookies(cookies)
				.data("ctype", caseType).data("regno", caseNumber).data("regyr", filingYear)
				.data("captcha_code", captcha).data("randomid", randomId).method(Connection.Method.POST).timeout(10000)
				.execute();

		String html = response.body();

		// 3️⃣ Parse data (Dummy example - you will map real fields here)
		CaseDetails details = new CaseDetails();
		details.setCaseType(caseType);
		details.setCaseNumber(caseNumber);
		details.setFilingYear(filingYear);
		details.setParties("Parsed from site"); // TODO: parse parties from html
		details.setRawResponse(html);
		details.setTimestamp(LocalDateTime.now());

		repository.save(details);
		return details;
	}

	public String getCaptchaCode() throws Exception {
		String baseUrl = "https://dhccaseinfo.nic.in/pcase/guiCaseWise.php";

		Connection.Response mainPage = Jsoup.connect(baseUrl).userAgent("Mozilla/5.0").timeout(10000).execute();

		String html = mainPage.body();
		Document doc = Jsoup.parse(html);

		// Extract numeric captcha
		String captcha = doc.select("label#cap font").text();
		if (captcha == null || captcha.isEmpty()) {
			throw new RuntimeException("Captcha code not found on page");
		}

		System.out.println("Captcha code found: " + captcha);
		return captcha;
	}

}
