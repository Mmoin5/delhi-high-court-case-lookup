package com.courtdata.court_data_fetcher.service;

import java.time.LocalDateTime;
import java.util.Map;

import org.jsoup.Connection;
import org.jsoup.Jsoup;
import org.jsoup.nodes.Document;
import org.jsoup.select.Elements;
import org.springframework.stereotype.Service;

import com.courtdata.court_data_fetcher.entity.CaseDetails;
import com.courtdata.court_data_fetcher.repository.QueryLogRepository;

import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class CourtDataService {

	private final QueryLogRepository repository;

	public CaseDetails fetchCaseDetails(String caseType, String caseNumber, String filingYear) throws Exception {
		String searchUrl = "https://dhccaseinfo.nic.in/pcase/case_history.php";

		// 1Ô∏è‚É£ Get captcha code dynamically
		String baseUrl = "https://dhccaseinfo.nic.in/pcase/guiCaseWise.php";
		Connection.Response mainPage = Jsoup.connect(baseUrl).userAgent("Mozilla/5.0").timeout(15000).execute();

		Map<String, String> cookies = mainPage.cookies();
		Document doc = Jsoup.parse(mainPage.body());
		String captcha = doc.select("label#cap font").text();
		String randomId = doc.select("input#randomid").attr("value");

		if (captcha.isEmpty()) {
			throw new RuntimeException("Failed to get captcha");
		}

		System.out.println("Using Captcha: " + captcha);

		// 2Ô∏è‚É£ Submit form with case details (main page)
		Connection.Response response = Jsoup.connect(searchUrl).userAgent("Mozilla/5.0 (Windows NT 10.0; Win64; x64)")
				.cookies(cookies).data("ctype", caseType).data("regno", caseNumber).data("regyr", filingYear)
				.data("captcha_code", captcha).data("randomid", randomId).method(Connection.Method.POST).timeout(60000)
				.execute();

		String html = response.body();
		Document resultDoc = Jsoup.parse(html);

		// 3Ô∏è‚É£ Parse case info
		String filingDate = resultDoc.select("td:contains(Date of Filing :) + td").text();
		String nextHearingDate = resultDoc.select("td:contains(Date of Disposal :) + td").text();

		String parties = "";
		Elements partyElements = resultDoc.select("table font b");
		if (partyElements.size() >= 2) {
			parties = partyElements.get(0).text() + " Vs. " + partyElements.get(1).text();
		}

		// Default no PDF
		String latestOrderPDF = "No PDF Available";

		// 4Ô∏è‚É£ Extract hidden fields to request Listing Details
		String caseTypeHidden = resultDoc.select("input[name=ctype]").attr("value");
		String caseNoHidden = resultDoc.select("input[name=cnum]").attr("value");
		String caseYearHidden = resultDoc.select("input[name=cyear]").attr("value");

		if (!caseTypeHidden.isEmpty() && !caseNoHidden.isEmpty() && !caseYearHidden.isEmpty()) {
			try {
				// 5Ô∏è‚É£ Request Listing Details page (where PDF links are)
				Connection.Response listingResponse = Jsoup.connect("https://dhccaseinfo.nic.in/pcase/case_history.php")
						.userAgent("Mozilla/5.0").cookies(cookies).data("casetype", caseTypeHidden)
						.data("caseno", caseNoHidden).data("caseyr", caseYearHidden).data("listing", "Listing Details") // üëà
																														// This
																														// triggers
																														// order/judgment
																														// table
						.method(Connection.Method.POST).timeout(60000).execute();

				Document listingDoc = Jsoup.parse(listingResponse.body());
				String pdfLink = listingDoc.select("a[href$=.pdf]").first() != null
						? listingDoc.select("a[href$=.pdf]").first().attr("abs:href")
						: "";

				if (!pdfLink.isEmpty()) {
					latestOrderPDF = pdfLink;
				}
			} catch (Exception e) {
				System.err.println("Error fetching Listing Details PDF: " + e.getMessage());
			}
		}

		// 6Ô∏è‚É£ Save to entity
		CaseDetails details = new CaseDetails();
		details.setCaseType(caseType);
		details.setCaseNumber(caseNumber);
		details.setFilingYear(filingYear);
		details.setFilingDate(filingDate.isEmpty() ? null : filingDate);
		details.setNextHearingDate(nextHearingDate.isEmpty() ? null : nextHearingDate);
		details.setParties(parties.isEmpty() ? "Not Available" : parties);
		details.setLatestOrderPDF(latestOrderPDF);
		details.setRawResponse(html);
		details.setTimestamp(LocalDateTime.now());

		repository.save(details);
		return details;
	}

	public String getCaptchaCode() throws Exception {
		String baseUrl = "https://dhccaseinfo.nic.in/pcase/guiCaseWise.php";

		Connection.Response mainPage = Jsoup.connect(baseUrl).userAgent("Mozilla/5.0").timeout(10000).execute();

		String html = mainPage.body();
		Document doc = Jsoup.parse(html);

		// Extract numeric captcha
		String captcha = doc.select("label#cap font").text();
		if (captcha == null || captcha.isEmpty()) {
			throw new RuntimeException("Captcha code not found on page");
		}

		System.out.println("Captcha code found: " + captcha);
		return captcha;
	}

}
